<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>modulos.fluxos.crm &mdash; Sample Docs v2019.07.29 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Sample Docs
          </a>
              <div class="version">
                v2019.07.29
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../module/modules.html">modulos</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Sample Docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>modulos.fluxos.crm</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for modulos.fluxos.crm</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">f</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.types</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">modulos.utils.gcs</span> <span class="kn">import</span> <span class="n">read_from_gcs</span>
<span class="kn">from</span> <span class="nn">modulos.utils.spark_</span> <span class="kn">import</span> <span class="n">save_BQ</span><span class="p">,</span> <span class="n">read_BQ</span>
<span class="kn">from</span> <span class="nn">modulos.process.tratamento_crm</span> <span class="kn">import</span> <span class="n">DeepDiveCRM_Tratamento</span>
<span class="kn">from</span> <span class="nn">modulos.process.date</span> <span class="kn">import</span> <span class="n">dates_between</span><span class="p">,</span> <span class="n">today</span><span class="p">,</span> <span class="n">info_date</span><span class="p">,</span> <span class="n">get_week_init_end_years</span>
<span class="kn">from</span> <span class="nn">modulos.process.de_paras</span> <span class="kn">import</span> <span class="n">de_para_valores_coluna</span>
<span class="kn">from</span> <span class="nn">modulos.utils.delta_</span> <span class="kn">import</span> <span class="n">read_delta</span><span class="p">,</span> <span class="n">update_historical_delta</span>
<span class="kn">from</span> <span class="nn">modulos.read_metadata</span> <span class="kn">import</span> <span class="n">read_metadata</span>
<span class="n">meta_data</span> <span class="o">=</span> <span class="n">read_metadata</span><span class="p">()</span>

<div class="viewcode-block" id="DeepDiveCRM_Janela12M"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Janela12M">[docs]</a><span class="k">class</span> <span class="nc">DeepDiveCRM_Janela12M</span><span class="p">(</span><span class="n">DeepDiveCRM_Tratamento</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classe para montar a base de Janela Rolante dos últimos 12 meses.</span>
<span class="sd">    Filha da classe DeepDiveCRM_Tratamento, pois necessita de todos os tratamentos de base que são realizados na classe-mãe</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        spark: (spark session) spark session</span>
<span class="sd">        DeltaTable: (DeltaTable) DeltaTable session</span>
<span class="sd">        path_contratos: (str) caminho para a base histórica de contratos</span>
<span class="sd">        path_historical_data: (str) caminho para a base histórica de janela rolante</span>
<span class="sd">        start_datetime: (str) Data inicial, no formato %Y-%m-%d</span>
<span class="sd">        end_datetime: (str) Data final, no formato %Y-%m-%d, optional</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spark</span><span class="p">,</span> <span class="n">DeltaTable</span><span class="p">,</span> <span class="n">path_contratos</span><span class="p">,</span> <span class="n">path_historical_data</span><span class="p">,</span> <span class="n">start_datetime</span><span class="p">,</span> <span class="n">end_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">path_contratos</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">DeltaTable</span> <span class="o">=</span> <span class="n">DeltaTable</span>
        <span class="k">if</span> <span class="n">end_datetime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_datetime</span> <span class="o">=</span> <span class="n">today</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">list_dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dates_between</span><span class="p">(</span><span class="n">start_datetime</span><span class="p">,</span> <span class="n">end_datetime</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_janela_12m</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_historical_data</span> <span class="o">=</span> <span class="n">path_historical_data</span>

<div class="viewcode-block" id="DeepDiveCRM_Janela12M._janela_12m_por_data"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Janela12M._janela_12m_por_data">[docs]</a>    <span class="k">def</span> <span class="nf">_janela_12m_por_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Executa a janela rolante de 12 meses pra trás, a partir de cada data na base Contrato Diárias</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">schema_completo</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">StructType</span><span class="p">([</span>
            <span class="n">t</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">DateType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;contratos_12m&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;clientes_12m&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;freq_ltm&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">FloatType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;clientes_fech&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;churn&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;churn_perc&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">FloatType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_janela_12m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[],</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema_completo</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        
        <span class="c1"># Contratos, clientes e churn dos últimos 12m pra cada data</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_dates</span><span class="p">:</span>

            <span class="c1"># ----------------------- Cálculo de clientes -------------------</span>

            <span class="n">df_contratos_for</span> <span class="o">=</span> <span class="p">(</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span>
                                   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;same_day_last_year&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">add_months</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="o">-</span><span class="mi">12</span><span class="p">))</span> 
                                   <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;same_day_last_year&#39;</span><span class="p">))</span> <span class="o">&amp;</span> 
                                           <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                                          <span class="p">)</span>
                               <span class="p">)</span>

            <span class="n">df_parcial</span> <span class="o">=</span> <span class="p">(</span>
                             <span class="n">df_contratos_for</span>
                             <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">collect_set</span><span class="p">(</span><span class="s1">&#39;cd_contrato_mae&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;contratos_12m&#39;</span><span class="p">),</span> 
                                  <span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">collect_set</span><span class="p">(</span><span class="s1">&#39;cliente&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;clientes_12m&#39;</span><span class="p">))</span> 
                             <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;freq_ltm&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;contratos_12m&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;clientes_12m&#39;</span><span class="p">))</span> 
                             <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>
                         <span class="p">)</span>

            <span class="c1"># ----------------------- Cálculo do churn -------------------</span>

            <span class="n">df_for</span> <span class="o">=</span> <span class="p">(</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
                         <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;same_day_last_year&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">add_months</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="o">-</span><span class="mi">12</span><span class="p">))</span> 
                         <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;same_day_last_year&#39;</span><span class="p">))</span> <span class="o">&amp;</span> 
                                 <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                                <span class="p">)</span>
                      <span class="p">)</span>

            <span class="c1"># Considera apenas os dias de abertura e fechamento das locações do cliente para análise</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;Tb&#39;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;abertura&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">))]</span>

            <span class="c1"># Considera apenas a última versão de cada cliente dentro da janela de 1 ano (linha 411)</span>
            <span class="n">w_last_cli</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;cliente&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span>

            <span class="n">df_parcial_churn</span> <span class="o">=</span> <span class="p">(</span>
                                   <span class="n">df_for</span>
                                   <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">)</span> 
                                   <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> 
                                   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;row_cliente&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_last_cli</span><span class="p">))</span> 
                                   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;cliente_churn&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">365</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;row_cliente&#39;</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> 
                                   <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">collect_set</span><span class="p">(</span><span class="s1">&#39;cliente&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;clientes_fech&#39;</span><span class="p">),</span> 
                                        <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;cliente_churn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;churn&#39;</span><span class="p">))</span> 
                                   <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;churn&#39;</span><span class="p">])</span> 
                                   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;churn_perc&#39;</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;churn&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;clientes_fech&#39;</span><span class="p">))</span> 
                                   <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>
                               <span class="p">)</span>
            
            <span class="c1"># ----------------------- Join visão clientes e churn -----------------------</span>
            <span class="n">df_completo</span> <span class="o">=</span> <span class="n">df_parcial</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_parcial_churn</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span>
                        
            <span class="n">df_parcial</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
            <span class="n">df_parcial</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
            <span class="n">df_parcial</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">df_parcial_churn</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
            <span class="n">df_parcial_churn</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
            <span class="n">df_parcial_churn</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">df_janela_12m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_janela_12m</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">df_completo</span><span class="p">)</span>

        <span class="c1"># ----------------------- Adiciona no Delta -----------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_janela_12m</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_janela_12m</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">update_historical_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_historical_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_janela_12m</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeltaTable</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeepDiveCRM_Janela12M.process_update_data"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Janela12M.process_update_data">[docs]</a>    <span class="k">def</span> <span class="nf">process_update_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_treatments</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_janela_12m_por_data</span><span class="p">()</span></div></div>
        
<div class="viewcode-block" id="DeepDiveCRM_Analise"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise">[docs]</a><span class="k">class</span> <span class="nc">DeepDiveCRM_Analise</span><span class="p">(</span><span class="n">DeepDiveCRM_Tratamento</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classe para realizar a análise Deep Dive CRM.</span>
<span class="sd">    Filha da classe DeepDiveCRM_Tratamento, pois necessita de todos os tratamentos de base que são realizados na classe-mãe</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        spark: (spark session) spark session</span>
<span class="sd">        path_contratos: (str) caminho para a base histórica de contratos</span>
<span class="sd">        path_historical_data: (str) caminho para a base histórica de janela rolante</span>
<span class="sd">        initial_path_to_save_result: (str) caminho para salvar as bases resultantes da análise</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spark</span><span class="p">,</span> <span class="n">path_contratos</span><span class="p">,</span> <span class="n">path_historical_data</span><span class="p">,</span> <span class="n">initial_path_to_save_result</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">path_contratos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_historical_data</span> <span class="o">=</span> <span class="n">path_historical_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span> <span class="o">=</span> <span class="n">initial_path_to_save_result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_diario</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_semanal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_mensal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_anual</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_acum_ano_diaria</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_acum_ano_semanal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_acum_ano_mensal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_rolante_diaria</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_rolante_semanal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_rolante_mensal</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="c1"># ---------------------- Crescimento líquido da base de clientes ----------------------</span>

<div class="viewcode-block" id="DeepDiveCRM_Analise._agg_fluxo"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise._agg_fluxo">[docs]</a>    <span class="k">def</span> <span class="nf">_agg_fluxo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        A partir da base Contrato Diárias, agrega as seguintes métricas no grão informado em &lt;grupo&gt;:</span>
<span class="sd">        - contagem total de clientes e de contratos,</span>
<span class="sd">        - contagem de clientes subdividido pelos seus respectivos status (Novos, Recorrentes, Reativados, Churn),</span>
<span class="sd">        - variação (saldo) de clientes</span>

<span class="sd">        Args:</span>
<span class="sd">            group: (list of str) vetor com os nomes das colunas para agrupamento</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Considera apenas os dias de abertura e fechamento das locações do cliente para análise</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;Tb&#39;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;abertura&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">))]</span>

        <span class="c1"># Contratos</span>
        <span class="n">df_contratos_periodo</span> <span class="o">=</span> <span class="p">(</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                   <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">)</span> 
                                   <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;abertura&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> 
                                   <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> 
                                   <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">collect_set</span><span class="p">(</span><span class="s1">&#39;cd_contrato_mae&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;contratos&#39;</span><span class="p">))</span>
                               <span class="p">)</span>
        
        <span class="c1"># Aquisição</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">([</span><span class="s1">&#39;cliente&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="n">df_status_abertura</span> <span class="o">=</span> <span class="p">(</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
                                 <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">)</span> 
                                 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;abertura&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> 
                                 <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> 
                                 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;row == 1&#39;</span><span class="p">)</span> 
                                 <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;row&#39;</span><span class="p">)</span> 
                                 <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> 
                                 <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;clientes&#39;</span><span class="p">),</span> 
                                      <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Novo&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;novos&#39;</span><span class="p">),</span>
                                      <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Recorrente&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;recorrentes&#39;</span><span class="p">),</span>
                                      <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Reativado&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;reativados&#39;</span><span class="p">))</span>
                             <span class="p">)</span>

        <span class="c1"># Churn</span>
        <span class="c1"># Muda a granularidade pelas datas de churn: &#39;ano_churn&#39;, &#39;mes_churn&#39;, &#39;semana_churn&#39;</span>
        <span class="n">group_churn</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="s1">&#39;_churn&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">group</span><span class="p">}</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">([</span><span class="s1">&#39;cliente&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">group_churn</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span>
        <span class="n">df_churn_aquisicao_status</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
                                        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data_churn&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;data_churn&#39;</span><span class="p">))</span> 
                                        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">)</span> 
                                        <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;churn&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">))</span> 
                                        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> 
                                        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;row == 1&#39;</span><span class="p">)</span> 
                                        <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">group_churn</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> 
                                        <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">365</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;churn&#39;</span><span class="p">))</span>
                                    <span class="p">)</span>

        <span class="c1"># Volta os nomes para conseguir dar join</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">group_churn</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df_churn_aquisicao_status</span> <span class="o">=</span> <span class="n">df_churn_aquisicao_status</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># Merge</span>
        <span class="n">df_fluxo</span> <span class="o">=</span> <span class="p">(</span>
                       <span class="n">df_contratos_periodo</span>
                       <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_status_abertura</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span> 
                       <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_churn_aquisicao_status</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span> 
                       <span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
                       <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;variacao&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;novos&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;reativados&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;churn&#39;</span><span class="p">))</span>
                   <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df_fluxo</span></div>


<div class="viewcode-block" id="DeepDiveCRM_Analise._agg_fluxo_diario"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise._agg_fluxo_diario">[docs]</a>    <span class="k">def</span> <span class="nf">_agg_fluxo_diario</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as métricas referentes à base de clientes no grão diário</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define a granularidade das análises</span>
        <span class="n">group</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;dia&#39;</span><span class="p">,</span><span class="s1">&#39;mes&#39;</span><span class="p">,</span><span class="s1">&#39;ano&#39;</span><span class="p">]</span>

        <span class="c1"># Executa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_diario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agg_fluxo</span><span class="p">(</span><span class="n">group</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DeepDiveCRM_Analise._agg_fluxo_semanal"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise._agg_fluxo_semanal">[docs]</a>    <span class="k">def</span> <span class="nf">_agg_fluxo_semanal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as métricas referentes à base de clientes no grão semanal</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define a granularidade das análises</span>
        <span class="n">group</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;referencia_ano&#39;</span><span class="p">,</span><span class="s1">&#39;referencia_semana&#39;</span><span class="p">,</span><span class="s1">&#39;week_init&#39;</span><span class="p">,</span><span class="s1">&#39;week_end&#39;</span><span class="p">]</span>

        <span class="c1"># Executa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_semanal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agg_fluxo</span><span class="p">(</span><span class="n">group</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeepDiveCRM_Analise._agg_fluxo_mensal"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise._agg_fluxo_mensal">[docs]</a>    <span class="k">def</span> <span class="nf">_agg_fluxo_mensal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as métricas referentes à base de clientes no grão mensal</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define a granularidade das análises</span>
        <span class="n">group</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span><span class="s1">&#39;mes&#39;</span><span class="p">]</span>

        <span class="c1"># Executa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_mensal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agg_fluxo</span><span class="p">(</span><span class="n">group</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DeepDiveCRM_Analise._agg_fluxo_anual"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise._agg_fluxo_anual">[docs]</a>    <span class="k">def</span> <span class="nf">_agg_fluxo_anual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as métricas referentes à base de clientes no grão anual</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define a granularidade das análises</span>
        <span class="n">group</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ano&#39;</span><span class="p">]</span>

        <span class="c1"># Executa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_anual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agg_fluxo</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        
        <span class="c1"># Adiciona coluna de churn %</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;ano&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_anual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_anual</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;churn_percentual&#39;</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">lag</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;churn&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;clientes&#39;</span><span class="p">))</span></div>

    <span class="c1"># ---------------------- Frequência acumulada fechada no ano ----------------------</span>

<div class="viewcode-block" id="DeepDiveCRM_Analise._get_freq_acum_dentro_ano"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise._get_freq_acum_dentro_ano">[docs]</a>    <span class="k">def</span> <span class="nf">_get_freq_acum_dentro_ano</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_cols</span><span class="p">,</span> <span class="n">order_partition_cols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        A partir da base Contratos, agrega as seguintes métricas no grão informado em &lt;group_cols&gt;, mantendo a última informação dentro da partição, ordenada por &lt;order_partition_cols&gt;</span>
<span class="sd">        - contagem de clientes e de contratos,</span>
<span class="sd">        - contagem cumulativa dentro do ano (YTD) de clientes e contratos,</span>
<span class="sd">        - razão entre contratos e clientes acumulados (frequência acumulada)</span>

<span class="sd">        Args:</span>
<span class="sd">            group_cols: (list of str) vetor com os nomes das colunas para agrupamento</span>
<span class="sd">            order_partition_cols: (list of str) vetor com os nomes das colunas que serão usadas para ordenar a partição de contratos e de clientes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Cálculo de contratos e clientes acumulado por semana</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;ano&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">order_partition_cols</span><span class="p">)</span><span class="o">.</span><span class="n">rowsBetween</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Mantém só a primeira aparição do Contrato dentro do ano, pra não contar 2x</span>
        <span class="n">w_contrato</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span><span class="s1">&#39;cd_contrato_mae&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">order_partition_cols</span><span class="p">)</span>
        
        <span class="n">contratos_cumsum</span> <span class="o">=</span> <span class="p">(</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span>
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                               <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;abertura&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;first_time&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_contrato</span><span class="p">))</span> 
                               <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;first_time == 1&#39;</span><span class="p">)</span> 
                               <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols</span><span class="p">)</span> 
                               <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;cd_contrato_mae&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;qtde_contratos&#39;</span><span class="p">))</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;qtd_contratos_acum&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;qtde_contratos&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
                           <span class="p">)</span>
        
        <span class="c1"># Mantém só a primeira aparição do Cliente dentro do ano, pra não contar 2x</span>
        <span class="n">w_cliente</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span><span class="s1">&#39;cliente&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">order_partition_cols</span><span class="p">)</span>
        
        <span class="n">clientes_cumsum</span> <span class="o">=</span> <span class="p">(</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span>
                              <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                              <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;abertura&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> 
                              <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;first_time&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w_cliente</span><span class="p">))</span> 
                              <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;first_time == 1&#39;</span><span class="p">)</span> 
                              <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols</span><span class="p">)</span> 
                              <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;cliente&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;qtde_clientes&#39;</span><span class="p">))</span> 
                              <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;qtd_clientes_acum&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;qtde_clientes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
                          <span class="p">)</span>

        <span class="c1"># Merge e obtenção da frequência acumulada</span>
        <span class="n">df_final</span> <span class="o">=</span> <span class="p">(</span>
                       <span class="n">contratos_cumsum</span>
                       <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clientes_cumsum</span><span class="p">,</span> <span class="n">group_cols</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span> 
                       <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;freq_acum&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;qtd_contratos_acum&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;qtd_clientes_acum&#39;</span><span class="p">))</span>
                   <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df_final</span></div>


<div class="viewcode-block" id="DeepDiveCRM_Analise._get_freq_acum_diaria"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise._get_freq_acum_diaria">[docs]</a>    <span class="k">def</span> <span class="nf">_get_freq_acum_diaria</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as métricas referentes a clientes e contratos acumulados YTD (year-to-date) no grão diário</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="s1">&#39;dia&#39;</span><span class="p">]</span>
        <span class="n">order_partition_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">freq_acum_ano_diaria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_freq_acum_dentro_ano</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">order_partition_cols</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="DeepDiveCRM_Analise._get_freq_acum_semanal"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise._get_freq_acum_semanal">[docs]</a>    <span class="k">def</span> <span class="nf">_get_freq_acum_semanal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as métricas referentes a clientes e contratos acumulados YTD (year-to-date) no grão semanal</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="s1">&#39;referencia_semana&#39;</span><span class="p">,</span> <span class="s1">&#39;week_init&#39;</span><span class="p">,</span> <span class="s1">&#39;week_end&#39;</span><span class="p">]</span>
        <span class="n">order_partition_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;week_init&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">freq_acum_ano_semanal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_freq_acum_dentro_ano</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">order_partition_cols</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="DeepDiveCRM_Analise._get_freq_acum_mensal"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise._get_freq_acum_mensal">[docs]</a>    <span class="k">def</span> <span class="nf">_get_freq_acum_mensal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as métricas referentes a clientes e contratos acumulados YTD (year-to-date) no grão mensal</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="s1">&#39;mes&#39;</span><span class="p">]</span>
        <span class="n">order_partition_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mes&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">freq_acum_ano_mensal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_freq_acum_dentro_ano</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">order_partition_cols</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeepDiveCRM_Analise._get_freq_acum_anual_rolante"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise._get_freq_acum_anual_rolante">[docs]</a>    <span class="k">def</span> <span class="nf">_get_freq_acum_anual_rolante</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as seguintes métricas no grão diário, para uma janela rolante que enxerga 12 meses para trás de cada data (LTM - Last Twelve Months):</span>
<span class="sd">        - contagem de clientes e de contratos,</span>
<span class="sd">        - razão entre contratos e clientes (frequência LTM),</span>
<span class="sd">        - contagem de clientes cujos contratos já foram fechados,</span>
<span class="sd">        - contagem de churns,</span>
<span class="sd">        - razão entre churns e clientes fechados (churn percentual).</span>
<span class="sd">        Partindo do grão diário, filtra o último dia de cada semana e de cada mês para obter os grãos semanal e mensal</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Lê delta</span>
        <span class="n">df_delta</span> <span class="o">=</span> <span class="n">read_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">,</span> <span class="n">datapath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_historical_data</span><span class="p">)</span>
        
        <span class="c1"># Grão Dia</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_rolante_diaria</span> <span class="o">=</span> <span class="n">df_delta</span>
        
        <span class="c1"># Grão Semana --&gt; total até o último dia da semana</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_rolante_semanal</span> <span class="o">=</span> <span class="n">df_delta</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="p">,</span> <span class="n">df_delta</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="o">.</span><span class="n">week_end</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        
        <span class="c1"># Grão Mês --&gt; total até o último dia do mês</span>
        <span class="n">df_last_day_month</span> <span class="o">=</span> <span class="n">df_delta</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;last_day_month&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">last_day</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;last_day_month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_rolante_mensal</span> <span class="o">=</span> <span class="n">df_delta</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_last_day_month</span><span class="p">,</span> <span class="n">df_delta</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">df_last_day_month</span><span class="o">.</span><span class="n">last_day_month</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span></div>
            
    <span class="c1"># ---------------------- All together -----------------------------</span>

<div class="viewcode-block" id="DeepDiveCRM_Analise.execute_analysis"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise.execute_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">execute_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executa os métodos para gerar as tabelas agregadas</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_agg_fluxo_diario</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agg_fluxo_semanal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agg_fluxo_mensal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agg_fluxo_anual</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_freq_acum_diaria</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_freq_acum_semanal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_freq_acum_mensal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_freq_acum_anual_rolante</span><span class="p">()</span></div>


<div class="viewcode-block" id="DeepDiveCRM_Analise.base_dash"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.DeepDiveCRM_Analise.base_dash">[docs]</a>    <span class="k">def</span> <span class="nf">base_dash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executa os tratamentos, as análises e salva os resultados no Big Query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_treatments</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_analysis</span><span class="p">()</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_diario</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Status_Clientes_PF_Diario&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_semanal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Status_Clientes_PF_Semanal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>    
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_mensal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Status_Clientes_PF_Mensal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_fluxo_anual</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Status_Clientes_PF_Anual&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_acum_ano_diaria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Freq_PF_Acum_Diario&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_acum_ano_semanal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Freq_PF_Acum_Semanal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_acum_ano_mensal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Freq_PF_Acum_Mensal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_rolante_diaria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Freq_PF_Acum_Rol_Diario&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_rolante_semanal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Freq_PF_Acum_Rol_Semanal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_rolante_mensal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Freq_PF_Acum_Rol_Mensal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;deep_dive_Data_Semana&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span></div></div>
        
<div class="viewcode-block" id="MDD_Report"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report">[docs]</a><span class="k">class</span> <span class="nc">MDD_Report</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classe para realizar a análise MD&amp;D Report</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        spark: (spark) spark session</span>
<span class="sd">        path_reservas: (str) caminho para a base histórica de reservas</span>
<span class="sd">        path_contratos: (str) caminho para a base histórica de contratos</span>
<span class="sd">        initial_path_to_save_result: (str) caminho para salvar as bases resultantes da análise</span>
<span class="sd">        considered_years: (list of int) anos considerados na análise, para filtrar as bases de contratos e reservas</span>
<span class="sd">        dict_map_cols_reservas: (dict) dicionário para informar o mapeamento de colunas da base de reservas para os nomes utilizados dentro da classe</span>
<span class="sd">        dict_rename_cols_reservas: (dict) dicionário para renomear as colunas da base de reservas, opcional</span>
<span class="sd">        dict_rename_cols_contratos: (dict) dicionário para renomear as colunas da base de contratos, opcional</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_reservas</span><span class="p">,</span> <span class="n">path_contratos</span><span class="p">,</span> <span class="n">initial_path_to_save_result</span><span class="p">,</span> <span class="n">spark</span><span class="p">,</span> <span class="n">considered_years</span><span class="p">,</span> <span class="n">dict_map_cols_reservas</span><span class="p">,</span> <span class="n">dict_rename_cols_reservas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dict_rename_cols_contratos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">cols_drop_ga</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;campanha_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;canal_origem_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;google_ads_ad_group_id_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;data_criacao_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;midia_ga&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;conteudo_anuncio_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;anuncio_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;campaign_id_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;palavra_chave_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;hit_number_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;visit_id_ga&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;canal_macro_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;ad_group_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;data_criacao_ga_dayofmonth&#39;</span><span class="p">,</span> <span class="s1">&#39;data_criacao_ga_year&#39;</span><span class="p">,</span> <span class="s1">&#39;data_criacao_ga_month&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;canal_origem_ga_enxuta&#39;</span><span class="p">,</span> <span class="s1">&#39;campanha_ga_enxuta&#39;</span><span class="p">,</span> <span class="s1">&#39;canal_origem_midia_ga_enxuta&#39;</span><span class="p">,</span> <span class="s1">&#39;de_para_campanha_ga_inv&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;esta_no_ga&#39;</span><span class="p">,</span> <span class="s1">&#39;canal_origem_midia_ga_enxuta_regra_adicional&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="p">(</span>
                               <span class="n">read_delta</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">datapath</span><span class="o">=</span><span class="n">path_reservas</span><span class="p">)</span>
                               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="o">*</span><span class="n">cols_drop_ga</span><span class="p">)</span>
                           <span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">read_delta</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">datapath</span><span class="o">=</span><span class="n">path_contratos</span><span class="p">)</span> 
                            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span> <span class="o">=</span> <span class="n">initial_path_to_save_result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">considered_years</span> <span class="o">=</span> <span class="n">considered_years</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_map_cols_reservas</span> <span class="o">=</span> <span class="n">dict_map_cols_reservas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_rename_cols_reservas</span> <span class="o">=</span> <span class="n">dict_rename_cols_reservas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_rename_cols_contratos</span> <span class="o">=</span> <span class="n">dict_rename_cols_contratos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;gs://</span><span class="si">{</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;GoogleStorage&quot;</span><span class="p">][</span><span class="s2">&quot;bucket_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/&#39;</span> <span class="o">+</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;GoogleStorage&quot;</span><span class="p">][</span><span class="s2">&quot;planilhas_auxiliares&quot;</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/&#39;</span> <span class="o">+</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;GoogleStorage&quot;</span><span class="p">][</span><span class="s2">&quot;planilhas_auxiliares&quot;</span><span class="p">][</span><span class="s2">&quot;agencias&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_agencias</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">de_para_canal</span> <span class="o">=</span> <span class="n">read_from_gcs</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;de_para_canal&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">de_para_ota</span> <span class="o">=</span> <span class="n">read_from_gcs</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;de_para_ota&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">de_para_ota_nome_empresa</span> <span class="o">=</span> <span class="n">read_from_gcs</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;de_para_ota_nome_empresa&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">de_para_parcerias</span> <span class="o">=</span> <span class="n">read_from_gcs</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;de_para_parcerias&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">de_para_parcerias_cpf</span> <span class="o">=</span> <span class="n">read_from_gcs</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;de_para_parcerias_cpf&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">de_para_agvig</span> <span class="o">=</span> <span class="n">read_from_gcs</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;de_para_agvig&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">de_para_carro</span> <span class="o">=</span> <span class="n">read_from_gcs</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;bucket_name&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;de_para_grupo_carro&#39;</span><span class="p">],</span>
                                                    <span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;GoogleStorage&#39;</span><span class="p">][</span><span class="s1">&#39;tratamento_crm&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vll_cliente</span> <span class="o">=</span> <span class="n">read_BQ</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;BigQuery&#39;</span><span class="p">][</span><span class="s1">&#39;vll_cliente&#39;</span><span class="p">],</span> <span class="n">spark</span><span class="p">,</span> <span class="n">columns_select</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cd_cliente&#39;</span><span class="p">,</span><span class="s1">&#39;cd_segmento&#39;</span><span class="p">],</span> <span class="n">filter_</span><span class="o">=</span><span class="s1">&#39;cd_segmento in (&quot;3&quot;,&quot;7&quot;)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_bkng_sgmt_bkng</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_bkng_sgmt_cntrct</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_bkng_sgmt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_bkng_chnl_bkng</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_bkng_chnl_cntrct</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao_chnl_cntrct</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_chnl_cntrct</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_chnl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_bkng_chnl_fleet_mix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_diaria</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_semanal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_mensal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_anual</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_diaria</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_semanal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_mensal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_anual</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reservas_abertas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="c1"># ---------------------- Prepare (select + rename cols) -----------------------------</span>

<div class="viewcode-block" id="MDD_Report._rename_cols_df_reservas"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._rename_cols_df_reservas">[docs]</a>    <span class="k">def</span> <span class="nf">_rename_cols_df_reservas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Renomeia colunas da base Reservas, pra rodar as funções sem ter que mudar nomes internamente</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_rename_cols_reservas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_rename_cols_reservas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span></div>


<div class="viewcode-block" id="MDD_Report._rename_cols_df_contratos"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._rename_cols_df_contratos">[docs]</a>    <span class="k">def</span> <span class="nf">_rename_cols_df_contratos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Renomeia colunas da base Contratos, pra rodar as funções sem ter que mudar nomes internamente</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_rename_cols_contratos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_rename_cols_contratos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span></div>

    <span class="c1"># ---------------------- Funções do Data Treatment  -----------------------------</span>

<div class="viewcode-block" id="MDD_Report._filtro_agencias_corporacao"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._filtro_agencias_corporacao">[docs]</a>    <span class="k">def</span> <span class="nf">_filtro_agencias_corporacao</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Filtra bases Reservas e Contratos para analisar apenas agências da corporação, excluindo as franqueadas</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">list_filiais</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;Agência&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_agencias</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;André&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Filial&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;ag_retirada_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_filiais</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;ag_retirada_contrato&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_filiais</span><span class="p">))</span></div>

<div class="viewcode-block" id="MDD_Report._treat_de_para_canal_crm"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_de_para_canal_crm">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_de_para_canal_crm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Atribui o canal da reserva/contrato, através dos De-Para de AGVIG, OTA e Parcerias.</span>
<span class="sd">        Ao final, gera arquivo com os casos sem mapeamento de canal</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># De-Para canal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="n">de_para_valores_coluna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_para_canal</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;origem_sistema&#39;</span><span class="p">,</span> <span class="n">new_column</span><span class="o">=</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="n">de_para_valores_coluna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">de_para_canal</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;origem_reserva_sistema&#39;</span><span class="p">,</span> <span class="n">new_column</span><span class="o">=</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">)</span>
        
        <span class="c1"># OTA</span>
        <span class="n">list_keys_de_para_ota</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_para_ota</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">mapping_expr_de_para_ota</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_map</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">de_para_ota</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>
        
        <span class="c1"># AGVIG</span>
        <span class="n">list_keys_de_para_agvig</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_para_agvig</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">mapping_expr_de_para_agvig</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_map</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">de_para_agvig</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>
        
        <span class="c1"># Parcerias</span>
        <span class="n">list_keys_de_para_parcerias</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_para_parcerias</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">mapping_expr_de_para_parcerias</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_map</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">de_para_parcerias</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>
        
        <span class="c1"># # Parcerias CPF ---&gt; depende do cluster interno</span>
        <span class="c1"># list_keys_de_para_parcerias_cpf = list(self.de_para_parcerias_cpf.keys())</span>
        <span class="c1"># mapping_expr_de_para_parcerias_cpf = f.create_map([f.lit(x) for x in chain(*self.de_para_parcerias_cpf.items())])</span>
        
        <span class="c1"># Fix some inconsistencies in the channel de-para</span>
        <span class="n">map_fix</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="s1">&#39;Site&#39;</span><span class="p">,</span> <span class="s1">&#39;RD&#39;</span><span class="p">:</span> <span class="s1">&#39;Site&#39;</span><span class="p">,</span> <span class="s1">&#39;UB&#39;</span><span class="p">:</span> <span class="s1">&#39;Site&#39;</span><span class="p">,</span> <span class="s1">&#39;H0&#39;</span><span class="p">:</span> <span class="s1">&#39;Inbound&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">:</span> <span class="s1">&#39;Inbound&#39;</span><span class="p">,</span> <span class="s1">&#39;WA&#39;</span><span class="p">:</span> <span class="s1">&#39;CERES&#39;</span><span class="p">,</span> <span class="s1">&#39;TN&#39;</span><span class="p">:</span> <span class="s1">&#39;Site&#39;</span><span class="p">}</span>
        <span class="n">list_keys_map_fix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">map_fix</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">mapping_expr_fix</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_map</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">map_fix</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>


        <span class="c1"># Preenche coluna &quot;canal_crm&quot; com os de-para</span>
        <span class="c1"># Usando &quot;mapping_expr&quot; pq precisamos realizar de-para seguindo uma condição baseada em outras coluna</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_de_para_ota</span><span class="p">),</span> 
                                                                             <span class="n">mapping_expr_de_para_ota</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)))</span>
                                                                       <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_de_para_agvig</span><span class="p">),</span> 
                                                                             <span class="n">mapping_expr_de_para_agvig</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)))</span>
                                                                       <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_promo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_de_para_parcerias</span><span class="p">),</span> 
                                                                             <span class="n">mapping_expr_de_para_parcerias</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_promo&#39;</span><span class="p">)))</span>
                                                                       <span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;origem_sistema&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_origem&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_map_fix</span><span class="p">)),</span> 
                                                                             <span class="n">mapping_expr_fix</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_origem&#39;</span><span class="p">)))</span>
                                                                       <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_origem&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Balcão&quot;</span><span class="p">))</span>
                                                                       <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">)))</span> \
                                             <span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s2">&quot;Balcão&quot;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">])</span>


        <span class="c1"># Adiciona canais AGVIG e OTA</span>
        <span class="n">df_cli_agvig_ota</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vll_cliente</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;cd_cliente&#39;</span><span class="p">,</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;cd_segmento&#39;</span><span class="p">,</span> <span class="s1">&#39;cd_segmento_agvig_replacement&#39;</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;desc_segmento_agvig_replacement&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_segmento_agvig_replacement&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;AGVIG&quot;</span><span class="p">)</span>
                                                                                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_segmento_agvig_replacement&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;OTA&quot;</span><span class="p">))</span>
                          <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_cli_agvig_ota</span><span class="p">,</span> <span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
                                                <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_de_para_ota</span><span class="p">),</span>
                                                                           <span class="n">mapping_expr_de_para_ota</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)))</span>
                                                                     <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_de_para_agvig</span><span class="p">),</span> 
                                                                           <span class="n">mapping_expr_de_para_agvig</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)))</span>
                                                                     <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;desc_segmento_agvig_replacement&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNotNull</span><span class="p">(),</span>
                                                                           <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;desc_segmento_agvig_replacement&#39;</span><span class="p">))</span>
                                                                     <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_promo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_de_para_parcerias</span><span class="p">),</span> 
                                                                           <span class="n">mapping_expr_de_para_parcerias</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_promo&#39;</span><span class="p">)))</span>
                                                                     <span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;origem_reserva_sistema&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_origem&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_map_fix</span><span class="p">)),</span> 
                                                                           <span class="n">mapping_expr_fix</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_origem&#39;</span><span class="p">)))</span>
                                                                     <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">)))</span>
                                                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;cd_segmento_agvig_replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;desc_segmento_agvig_replacement&#39;</span><span class="p">)</span>
                            <span class="p">)</span>

        <span class="c1"># Identificação de reservas sem mapeamento de canal</span>
        <span class="n">columns_select</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;cd_promo&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;origem_reserva_sistema&#39;</span><span class="p">,</span> <span class="s1">&#39;cd_origem&#39;</span><span class="p">,</span> <span class="s1">&#39;segmento_crm&#39;</span><span class="p">]</span>
        <span class="n">path_to_save_result</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;gs://</span><span class="si">{</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;GoogleStorage&quot;</span><span class="p">][</span><span class="s2">&quot;bucket_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/&#39;</span> <span class="o">+</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;GoogleStorage&quot;</span><span class="p">][</span><span class="s2">&quot;tratamento_crm&quot;</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/&#39;</span> <span class="o">+</span>
                               <span class="s1">&#39;faltantes/reservas_sem_canal.csv&#39;</span><span class="p">)</span>

        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;canal_crm IS NULL&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">columns_select</span><span class="p">)</span>
            <span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_to_save_result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="MDD_Report._treat_ota_nome_empresa"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_ota_nome_empresa">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_ota_nome_empresa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Atribui o nome da empresa da reserva/contrato através do De-Para de OTA</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># OTA Nome empresa</span>
        <span class="n">list_keys_de_para_ota_nome_empresa</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_para_ota_nome_empresa</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">mapping_expr_de_para_ota_nome_empresa</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_map</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">de_para_ota_nome_empresa</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>

        <span class="c1"># Preenche coluna &quot;nome_empresa&quot; com o de-para</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;nome_empresa&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_de_para_ota_nome_empresa</span><span class="p">),</span> 
                                                                                <span class="n">mapping_expr_de_para_ota_nome_empresa</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)))</span>
                                                                          <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;nome_empresa&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_de_para_ota_nome_empresa</span><span class="p">),</span> 
                                                                              <span class="n">mapping_expr_de_para_ota_nome_empresa</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_agvig_replacement&#39;</span><span class="p">)))</span>
                                                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;origem_reserva_sistema&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;GOL&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;GOL&quot;</span><span class="p">))</span>
                                                                        <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span></div>

<div class="viewcode-block" id="MDD_Report._treat_grupo_carro"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_grupo_carro">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_grupo_carro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Atribui o grupo de carro da reserva/contrato através do De-Para de carros</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Grupo carro</span>
        <span class="n">list_keys_de_para_carro</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de_para_carro</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">mapping_expr_de_para_carro</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_map</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">de_para_carro</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>

        <span class="c1"># Preenche coluna &quot;grp_origem_cat&quot; com o de-para</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;grp_origem_contrato_cat&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;grp_origem_contrato&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_de_para_carro</span><span class="p">),</span> 
                                                                                           <span class="n">mapping_expr_de_para_carro</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;grp_origem_contrato&#39;</span><span class="p">)))</span>
                                                                                     <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;grp_origem_reserva_cat&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;grp_origem_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_keys_de_para_carro</span><span class="p">),</span> 
                                                                                        <span class="n">mapping_expr_de_para_carro</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;grp_origem_reserva&#39;</span><span class="p">)))</span>
                                                                                  <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span></div>

<div class="viewcode-block" id="MDD_Report._treat_canal_direto_indireto"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_canal_direto_indireto">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_canal_direto_indireto</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Classifica o canal da reserva/contrato em direto ou indireto</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">map_channel_dir_indir</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;App&#39;</span><span class="p">:</span> <span class="s1">&#39;Direto&#39;</span><span class="p">,</span> <span class="s1">&#39;Site&#39;</span><span class="p">:</span> <span class="s1">&#39;Direto&#39;</span><span class="p">,</span> <span class="s1">&#39;Balcão&#39;</span><span class="p">:</span> <span class="s1">&#39;Direto&#39;</span><span class="p">,</span> <span class="s1">&#39;CERES&#39;</span><span class="p">:</span> <span class="s1">&#39;Direto&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;Parcerias&#39;</span><span class="p">:</span> <span class="s1">&#39;Indireto&#39;</span><span class="p">,</span> <span class="s1">&#39;OTA&#39;</span><span class="p">:</span> <span class="s1">&#39;Indireto&#39;</span><span class="p">,</span> <span class="s1">&#39;AGVIG&#39;</span><span class="p">:</span> <span class="s1">&#39;Indireto&#39;</span><span class="p">,</span> <span class="s1">&#39;Inbound&#39;</span><span class="p">:</span> <span class="s1">&#39;Direto&#39;</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="n">de_para_valores_coluna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="p">,</span> <span class="n">map_channel_dir_indir</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">,</span> <span class="n">new_column</span><span class="o">=</span><span class="s1">&#39;canal_crm_dir_indir&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MDD_Report._treat_contrato_mae"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_contrato_mae">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_contrato_mae</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Mantém na base Contratos somente a linha do contrato-mãe para cada reserva, ou as linhas de contratos sem reserva.</span>
<span class="sd">        Assim, quando houver join de Reservas e Contratos na classe, não duplica as reservas</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_abertura_efetiva&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">),</span> <span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span> \
                                             <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;manter_contrato_mae&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> \
                                             <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;manter_contrato_mae&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()))</span> \
                                             <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;manter_contrato_mae&#39;</span><span class="p">,</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MDD_Report._treat_status_reserva"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_status_reserva">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_status_reserva</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_name</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Padroniza os status de reservas/contratos considerando as informações das duas bases</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Join</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">,</span><span class="s1">&#39;status_reserva&#39;</span><span class="p">)</span> \
                             <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span><span class="s1">&#39;dt_abertura_efetiva&#39;</span><span class="p">,</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">),</span> <span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span> \

        <span class="c1"># Normaliza formatos coluna &quot;status&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;status_reserva&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">initcap</span><span class="p">(</span><span class="s1">&#39;status_reserva&#39;</span><span class="p">))</span> \
               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">initcap</span><span class="p">(</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">))</span>

        <span class="c1"># Corrige o status da reserva</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                 <span class="n">df</span>
                 <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;max_dt_abertura_efetiva&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s1">&#39;dt_abertura_efetiva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> 
                 <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Aberto&#39;</span><span class="p">,</span><span class="s1">&#39;Fechado&#39;</span><span class="p">]),</span> <span class="s1">&#39;Utilizada&#39;</span><span class="p">)</span>
                                       <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Cancelado&#39;</span><span class="p">,</span> <span class="s1">&#39;Cancelada&#39;</span><span class="p">)</span>
                                       <span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;max_dt_abertura_efetiva&#39;</span><span class="p">))</span> <span class="o">&amp;</span> 
                                             <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_reserva&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Cancelada&#39;</span><span class="p">),</span> <span class="s1">&#39;Perdida&#39;</span><span class="p">)</span>
                                       <span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_reserva&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Cancelada&#39;</span><span class="p">),</span> <span class="s1">&#39;Cancelada&#39;</span><span class="p">)</span>
                                       <span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;max_dt_abertura_efetiva&#39;</span><span class="p">))</span> <span class="o">&amp;</span> 
                                             <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_reserva&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Cancelada&#39;</span><span class="p">),</span> <span class="s1">&#39;Aberta&#39;</span><span class="p">))</span>
             <span class="p">)</span>

        <span class="c1"># Junta de volta na base Reservas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="s1">&#39;status_contrato&#39;</span><span class="p">),</span> <span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MDD_Report._treat_reservas_anos_absurdos"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_reservas_anos_absurdos">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_reservas_anos_absurdos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Remove os casos anômalos de Reservas baseado nas colunas valor de diária, valor total, quantidade de diárias, antecedência e ano de criação</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Trazendo fechou_contrato</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;fechou_contrato&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="p">(</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span>
                               <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span><span class="s1">&#39;fechou_contrato&#39;</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> 
                               <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fechou_contrato&#39;</span><span class="p">])</span>
                           <span class="p">)</span>
        
        <span class="c1"># Filtro parametrizado pelo nome das colunas</span>
        <span class="n">filter_sem_contrato</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                ((</span><span class="si">{}</span><span class="s2"> &gt;= 20) and (</span><span class="si">{}</span><span class="s2"> &lt;= 1000)) and</span>
<span class="s2">                                (</span><span class="si">{}</span><span class="s2"> &gt; 0) and</span>
<span class="s2">                                (</span><span class="si">{}</span><span class="s2"> &lt;= 365) and</span>
<span class="s2">                                (</span><span class="si">{}</span><span class="s2"> &lt;= 365) and</span>
<span class="s2">                                (</span><span class="si">{}</span><span class="s2"> &gt;= 2019)</span>
<span class="s2">                              &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_map_cols_reservas</span><span class="p">[</span><span class="s1">&#39;col_name_vlr_diaria&#39;</span><span class="p">],</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">dict_map_cols_reservas</span><span class="p">[</span><span class="s1">&#39;col_name_vlr_diaria&#39;</span><span class="p">],</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">dict_map_cols_reservas</span><span class="p">[</span><span class="s1">&#39;col_name_vlr_total&#39;</span><span class="p">],</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">dict_map_cols_reservas</span><span class="p">[</span><span class="s1">&#39;col_name_qtd_diarias&#39;</span><span class="p">],</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">dict_map_cols_reservas</span><span class="p">[</span><span class="s1">&#39;col_name_dias_anticipacao_reserva&#39;</span><span class="p">],</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">dict_map_cols_reservas</span><span class="p">[</span><span class="s1">&#39;col_name_ano_criacao_reserva&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;(fechou_contrato=1) or (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filter_sem_contrato</span><span class="p">))</span></div>

<div class="viewcode-block" id="MDD_Report._treat_date_related_columns"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_date_related_columns">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_date_related_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Acrescenta colunas de data (ano) nas bases Reservas e Contratos</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="p">(</span>
                               <span class="n">info_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_criacao_reserva&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span> 
                               <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva_year&#39;</span><span class="p">,</span> <span class="s1">&#39;year_retirada_reserva&#39;</span><span class="p">)</span> 
                               <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;dt_criacao_reserva_year&#39;</span><span class="p">,</span> <span class="s1">&#39;year_criacao_reserva&#39;</span><span class="p">)</span> 
                           <span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">info_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dt_abertura_efetiva&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span> 
                                <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;dt_abertura_efetiva_year&#39;</span><span class="p">,</span> <span class="s1">&#39;year_abertura_efetiva&#39;</span><span class="p">)</span> 
                            <span class="p">)</span></div>


<div class="viewcode-block" id="MDD_Report._treat_valor_contrato_uplift_reserva"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_valor_contrato_uplift_reserva">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_valor_contrato_uplift_reserva</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Acrescenta coluna de valor de receita para os contratos fechados.</span>
<span class="sd">        Acrescenta coluna de valor excedente do contrato em relação ao previsto na reserva</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Revenue expected for each closed contract. Given by: Revenue = (Contract Value - Gas - Restitution - Comission)*(1 - 524/10000)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;vlr_receita&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Fechado&quot;</span><span class="p">,</span> 
                                                                               <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">524</span><span class="o">/</span><span class="mi">10000</span><span class="p">)</span> <span class="o">*</span> 
                                                                               <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;vlr_contrato&#39;</span><span class="p">)</span> 
                                                                                <span class="o">-</span> <span class="n">f</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;vlr_combustivel&#39;</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> 
                                                                                <span class="o">-</span> <span class="n">f</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;vlr_indenizacao&#39;</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> 
                                                                                <span class="o">-</span> <span class="n">f</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;vlr_comissao&#39;</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span>
                                                                         <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        
        <span class="c1"># Merge the contract value</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;vlr_contrato&#39;</span><span class="p">,</span> <span class="s1">&#39;vlr_receita&#39;</span><span class="p">,</span> <span class="s1">&#39;qntd_diarias_contrato&#39;</span><span class="p">,</span><span class="s1">&#39;vlr_tx_retorno_contrato&#39;</span><span class="p">)</span>
        
        <span class="c1"># Calculate the uplift compared to the booking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="p">(</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;vlr_uplift&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Pessoa Física&quot;</span><span class="p">)</span> <span class="o">&amp;</span> 
                                                                <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;tp_reserva&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Diário&quot;</span><span class="p">)</span> <span class="o">&amp;</span> 
                                                                <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Utilizada&quot;</span><span class="p">),</span> 
                                                                <span class="n">f</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;vlr_contrato&#39;</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;vlr_reserva&#39;</span><span class="p">))</span>
                                          <span class="p">)</span>
                           <span class="p">)</span></div>

<div class="viewcode-block" id="MDD_Report._treat_dias_anteced_reserva"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_dias_anteced_reserva">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_dias_anteced_reserva</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Acrescenta coluna de dias de antecedência da reserva</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;antecedencia_reserva_dias&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">datediff</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dt_criacao_reserva&#39;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="MDD_Report._treat_reservas_canceladas"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._treat_reservas_canceladas">[docs]</a>    <span class="k">def</span> <span class="nf">_treat_reservas_canceladas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Atualiza coluna de valor contrato para reservas canceladas</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;vlr_contrato&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Cancelada&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;vlr_contrato&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                                                                        <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;vlr_contrato&#39;</span><span class="p">)))</span></div>
                
<div class="viewcode-block" id="MDD_Report._create_df_balcao"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._create_df_balcao">[docs]</a>    <span class="k">def</span> <span class="nf">_create_df_balcao</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Cria a base Balcão, composta pelos contratos cujo canal é Balcão ou que não tem reserva atrelada</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">years_reserva</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">year_retirada_reserva</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;year_retirada_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;year_abertura_efetiva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_reserva</span><span class="p">))</span> <span class="o">&amp;</span> 
                                                  <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Balcão&quot;</span><span class="p">)</span> <span class="o">&amp;</span> 
                                                  <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()))</span>

        <span class="n">de_para</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Fechado&#39;</span><span class="p">:</span> <span class="s1">&#39;Utilizada&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;Cancelado&#39;</span><span class="p">:</span> <span class="s1">&#39;Cancelada&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;Aberto&#39;</span><span class="p">:</span> <span class="s1">&#39;Aberta&#39;</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span> <span class="o">=</span> <span class="n">de_para_valores_coluna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span><span class="p">,</span> <span class="n">de_para</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">,</span> <span class="n">new_column</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MDD_Report._drop_unrealistic_values"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._drop_unrealistic_values">[docs]</a>    <span class="k">def</span> <span class="nf">_drop_unrealistic_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Colocar essa parte junto com a função &#39;treat_reservas_anos_absurdos&#39; pq se trata da mesma coisa</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;vlr_reserva&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;vlr_contrato&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">))</span></div>

<div class="viewcode-block" id="MDD_Report._drop_rows_without_segmento"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._drop_rows_without_segmento">[docs]</a>    <span class="k">def</span> <span class="nf">_drop_rows_without_segmento</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Remove as linhas de Reservas, Contratos e Balcão que tem segmento diferente dos casos considerados</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">seg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pessoa Física&#39;</span><span class="p">,</span> <span class="s1">&#39;Pessoa Jurídica&#39;</span><span class="p">,</span> <span class="s1">&#39;Replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;Ride Sharing&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Fleet&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">seg</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">seg</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">seg</span><span class="p">))</span></div>
    
    <span class="c1"># ---------------------- Nova visão de semana  -----------------------------</span>
    
<div class="viewcode-block" id="MDD_Report._new_referencia_semana"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._new_referencia_semana">[docs]</a>    <span class="k">def</span> <span class="nf">_new_referencia_semana</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Cria a base Semanas.</span>
<span class="sd">        Realiza join da base Semanas com as bases Reservas, Contratos e Balcão</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Cria DF referência das semanas</span>
        <span class="n">min_year_contratos</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">min_year</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;dt_abertura_efetiva&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;min_year&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">min_year_reservas</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">min_year</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;min_year&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">min_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">min_year_contratos</span><span class="p">,</span> <span class="n">min_year_reservas</span><span class="p">])</span>
        <span class="c1"># print(&#39;min_year {}&#39;.format(min_year))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span> <span class="o">=</span> <span class="n">get_week_init_end_years</span><span class="p">(</span><span class="n">min_year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>

        <span class="c1"># Reservas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="p">,</span> 
                                                  <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">dt_retirada_reserva</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="o">.</span><span class="n">week_init</span><span class="p">)</span> <span class="o">&amp;</span> 
                                                  <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">dt_retirada_reserva</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="o">.</span><span class="n">week_end</span><span class="p">),</span> 
                                                  <span class="s1">&#39;left&#39;</span><span class="p">)</span>
        
        <span class="c1"># Contratos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="p">,</span> 
                                                  <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">dt_abertura_efetiva</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="o">.</span><span class="n">week_init</span><span class="p">)</span> <span class="o">&amp;</span> 
                                                  <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">dt_abertura_efetiva</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="o">.</span><span class="n">week_end</span><span class="p">),</span> 
                                                  <span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="c1"># Balcão</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="p">,</span> 
                                                  <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span><span class="o">.</span><span class="n">dt_abertura_efetiva</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="o">.</span><span class="n">week_init</span><span class="p">)</span> <span class="o">&amp;</span> 
                                                  <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span><span class="o">.</span><span class="n">dt_abertura_efetiva</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="o">.</span><span class="n">week_end</span><span class="p">),</span> 
                                                  <span class="s1">&#39;left&#39;</span><span class="p">)</span></div>

    <span class="c1"># ---------------------- Funções de Analysis  -----------------------------</span>


<div class="viewcode-block" id="MDD_Report._common_analysis"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._common_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">_common_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_infos_reserva</span><span class="p">,</span> <span class="n">df_infos_contrato</span><span class="p">,</span> <span class="n">group_cols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as seguintes métricas no grão informado em &lt;group_cols&gt;:</span>
<span class="sd">        - quantidade de reservas/contratos,</span>
<span class="sd">        - valor total de reservas/contratos,</span>
<span class="sd">        - número de diárias de reservas/contratos.</span>
<span class="sd">        Análises comuns para Segmento e Canal</span>

<span class="sd">        Args:</span>
<span class="sd">            df_infos_reserva: (spark dataframe) base com informações de reservas</span>
<span class="sd">            df_infos_contrato: (spark dataframe) base com informações de contratos</span>
<span class="sd">            group_cols: (list of str) vetor com os nomes das colunas para agrupamento</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df_1</span> <span class="o">=</span> <span class="p">(</span>
                   <span class="n">df_infos_reserva</span>
                   <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols</span><span class="p">)</span> 
                   <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;vlr_contrato&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;qntd_contratos_fechados&#39;</span><span class="p">),</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;vlr_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;valor_total_reservas&#39;</span><span class="p">),</span> 
                        <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;qntd_diarias_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;total_diarias_reserva&#39;</span><span class="p">))</span> 
               <span class="p">)</span>

        <span class="n">df_2</span> <span class="o">=</span> <span class="p">(</span>
                   <span class="n">df_infos_contrato</span>
                   <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols</span><span class="p">)</span> 
                   <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;qntd_contratos_fechados&#39;</span><span class="p">),</span> 
                        <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;qntd_diarias_contrato&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;total_diarias_contrato&#39;</span><span class="p">),</span> 
                        <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;vlr_contrato&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;valor_total_contratos&#39;</span><span class="p">))</span>
               <span class="p">)</span>
                
        
        <span class="n">df_final</span> <span class="o">=</span> <span class="p">(</span>
                       <span class="n">df_1</span>
                       <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_2</span><span class="p">,</span> <span class="n">group_cols</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span> 
                       <span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                   <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df_final</span></div>


<div class="viewcode-block" id="MDD_Report._analysis_antecedencia_media"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._analysis_antecedencia_media">[docs]</a>    <span class="k">def</span> <span class="nf">_analysis_antecedencia_media</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_infos_reserva</span><span class="p">,</span> <span class="n">group_cols_generic</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega a antecedência média das reservas, agrupando por &lt;group_cols_generic&gt;, para os grãos diário, semanal, mensal e anual.</span>
<span class="sd">        Análises comuns para Segmento e Canal</span>

<span class="sd">        Args:</span>
<span class="sd">            df_infos_reserva: (spark dataframe) base com informações de reservas</span>
<span class="sd">            group_cols_generic: (list of str) vetor com os nomes das colunas para agrupamento</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">antec_media_diaria</span> <span class="o">=</span> <span class="p">(</span>
                                 <span class="n">df_infos_reserva</span>
                                 <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols_generic</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="s1">&#39;dia&#39;</span><span class="p">])</span> 
                                 <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="s1">&#39;antecedencia_reserva_dias&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;antecedencia_media_reserva&#39;</span><span class="p">))</span>
                             <span class="p">)</span>

        <span class="n">antec_media_semanal</span> <span class="o">=</span> <span class="p">(</span>
                                  <span class="n">df_infos_reserva</span>
                                  <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols_generic</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;referencia_semana&#39;</span><span class="p">,</span> <span class="s1">&#39;week_init&#39;</span><span class="p">,</span> <span class="s1">&#39;week_end&#39;</span><span class="p">])</span> 
                                  <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="s1">&#39;antecedencia_reserva_dias&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;antecedencia_media_reserva&#39;</span><span class="p">))</span>
                              <span class="p">)</span>

        <span class="n">antec_media_mensal</span> <span class="o">=</span> <span class="p">(</span>
                                 <span class="n">df_infos_reserva</span>
                                 <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols_generic</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="s1">&#39;mes&#39;</span><span class="p">])</span> 
                                 <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="s1">&#39;antecedencia_reserva_dias&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;antecedencia_media_reserva&#39;</span><span class="p">))</span>
                             <span class="p">)</span>

        <span class="n">antec_media_anual</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">df_infos_reserva</span>
                                <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols_generic</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ano&#39;</span><span class="p">])</span> 
                                <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="s1">&#39;antecedencia_reserva_dias&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;antecedencia_media_reserva&#39;</span><span class="p">))</span>
                            <span class="p">)</span>

        <span class="k">return</span> <span class="n">antec_media_diaria</span><span class="p">,</span> <span class="n">antec_media_semanal</span><span class="p">,</span> <span class="n">antec_media_mensal</span><span class="p">,</span> <span class="n">antec_media_anual</span></div>

    
<div class="viewcode-block" id="MDD_Report._analysis_by_pickup_day_by_segment"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._analysis_by_pickup_day_by_segment">[docs]</a>    <span class="k">def</span> <span class="nf">_analysis_by_pickup_day_by_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as seguintes métricas por segmento, tipo e status:</span>
<span class="sd">        - quantidade de reservas/contratos,</span>
<span class="sd">        - valor total de reservas/contratos,</span>
<span class="sd">        - número de diárias de reservas/contratos,</span>
<span class="sd">        - antecedência média de reservas</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">select_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;referencia_semana&#39;</span><span class="p">,</span> <span class="s1">&#39;week_init&#39;</span><span class="p">,</span> <span class="s1">&#39;week_end&#39;</span><span class="p">]</span>
        <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="s1">&#39;referencia_semana&#39;</span><span class="p">,</span> <span class="s1">&#39;week_init&#39;</span><span class="p">,</span> <span class="s1">&#39;week_end&#39;</span><span class="p">]</span>
        
        <span class="c1"># Table considering only the booking information</span>
        <span class="n">df_infos_reserva</span> <span class="o">=</span> <span class="p">(</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span>
                               <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNotNull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;year_retirada_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">considered_years</span><span class="p">)))</span> 
                               <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">select_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;qntd_diarias_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;vlr_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;antecedencia_reserva_dias&#39;</span><span class="p">])</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">))</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dayofmonth</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span>
                           <span class="p">)</span>

        <span class="c1"># Table considering the contract information</span>
        <span class="n">df_infos_contrato</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span>
                                <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Utilizada&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;year_retirada_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">considered_years</span><span class="p">)))</span> 
                                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">select_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;qntd_diarias_contrato&#39;</span><span class="p">,</span> <span class="s1">&#39;vlr_contrato&#39;</span><span class="p">,</span> <span class="p">])</span> 
                                <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">))</span> 
                                <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dayofmonth</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span>
                            <span class="p">)</span>

        <span class="c1"># Agregações comuns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_bkng_sgmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_analysis</span><span class="p">(</span><span class="n">df_infos_reserva</span><span class="p">,</span> <span class="n">df_infos_contrato</span><span class="p">,</span> <span class="n">group_cols</span><span class="p">)</span>

        <span class="c1"># Antecendência média</span>
        <span class="n">group_cols_generic</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_diaria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_semanal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_mensal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_anual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_antecedencia_media</span><span class="p">(</span><span class="n">df_infos_reserva</span><span class="p">,</span> <span class="n">group_cols_generic</span><span class="p">)</span></div>

<div class="viewcode-block" id="MDD_Report._analysis_by_pickup_day_by_channel"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._analysis_by_pickup_day_by_channel">[docs]</a>    <span class="k">def</span> <span class="nf">_analysis_by_pickup_day_by_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega as seguintes métricas por canal, segmento, tipo e status:</span>
<span class="sd">        - quantidade de reservas/contratos,</span>
<span class="sd">        - valor total de reservas/contratos,</span>
<span class="sd">        - número de diárias de reservas/contratos,</span>
<span class="sd">        - antecedência média de reservas</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">select_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;segmento_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;referencia_semana&#39;</span><span class="p">,</span> <span class="s1">&#39;week_init&#39;</span><span class="p">,</span> <span class="s1">&#39;week_end&#39;</span><span class="p">]</span>
        <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;canal_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span>  <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="s1">&#39;referencia_semana&#39;</span><span class="p">,</span> <span class="s1">&#39;week_init&#39;</span><span class="p">,</span> <span class="s1">&#39;week_end&#39;</span><span class="p">]</span>

        <span class="c1"># Table considering only the booking information</span>
        <span class="n">df_infos_reserva</span> <span class="o">=</span> <span class="p">(</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span>
                               <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNotNull</span><span class="p">())</span> <span class="o">&amp;</span> 
                                       <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;year_retirada_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">considered_years</span><span class="p">)))</span> 
                               <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">select_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;tp_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;qntd_diarias_reserva&#39;</span><span class="p">,</span> 
                                                      <span class="s1">&#39;vlr_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;antecedencia_reserva_dias&#39;</span><span class="p">])</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">))</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                               <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dayofmonth</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span>
                           <span class="p">)</span>

        <span class="c1"># Table considering the contract information</span>
        <span class="n">df_infos_contrato_1</span> <span class="o">=</span> <span class="p">(</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span>
                                  <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">initcap</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">))</span><span class="o">==</span><span class="s2">&quot;Fechado&quot;</span><span class="p">)</span> <span class="o">&amp;</span> 
                                          <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;year_retirada_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">considered_years</span><span class="p">)))</span> 
                                  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">select_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;tp_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;qntd_diarias_contrato&#39;</span><span class="p">,</span> <span class="s1">&#39;vlr_contrato&#39;</span><span class="p">])</span> 
                                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">))</span> 
                                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dayofmonth</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                  <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">)</span>
                              <span class="p">)</span>

        <span class="c1"># Table considering the contract information (Balcão)</span>
        <span class="n">df_infos_contrato_2</span> <span class="o">=</span> <span class="p">(</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span>
                                  <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;year_abertura_efetiva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">considered_years</span><span class="p">))</span> 
                                  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">select_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;tp_contrato&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_abertura_efetiva&#39;</span><span class="p">,</span> <span class="s1">&#39;qntd_diarias_contrato&#39;</span><span class="p">,</span> <span class="s1">&#39;vlr_contrato&#39;</span><span class="p">])</span> 
                                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;dt_abertura_efetiva&#39;</span><span class="p">))</span> 
                                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dayofmonth</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                  <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;tp_contrato&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_reserva&#39;</span><span class="p">)</span> 
                                  <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;dt_abertura_efetiva&#39;</span><span class="p">)</span>
                              <span class="p">)</span>

        <span class="n">df_infos_contrato</span> <span class="o">=</span> <span class="n">df_infos_contrato_1</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">df_infos_contrato_2</span><span class="p">)</span>

        <span class="c1"># Agregações</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_chnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_analysis</span><span class="p">(</span><span class="n">df_infos_reserva</span><span class="p">,</span> <span class="n">df_infos_contrato</span><span class="p">,</span> <span class="n">group_cols</span><span class="p">)</span>

        <span class="c1"># Antecendência média</span>
        <span class="n">group_cols_generic</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;canal_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_diaria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_semanal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_mensal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_anual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_antecedencia_media</span><span class="p">(</span><span class="n">df_infos_reserva</span><span class="p">,</span> <span class="n">group_cols_generic</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="MDD_Report._analysis_fleet_by_pickup_day_by_channel"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._analysis_fleet_by_pickup_day_by_channel">[docs]</a>    <span class="k">def</span> <span class="nf">_analysis_fleet_by_pickup_day_by_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega a contagem de reservas no grão diário, agrupado por canal, segmento, tipo, status e grupo de carro</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;canal_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;grp_origem_reserva_cat&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="s1">&#39;referencia_semana&#39;</span><span class="p">,</span> <span class="s1">&#39;week_init&#39;</span><span class="p">,</span> <span class="s1">&#39;week_end&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">df_bkng_chnl_fleet_mix</span> <span class="o">=</span> <span class="p">(</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span>
                                          <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">initcap</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status_contrato&#39;</span><span class="p">))</span><span class="o">==</span><span class="s2">&quot;Fechado&quot;</span><span class="p">)</span> <span class="o">&amp;</span> 
                                                            <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;year_retirada_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">considered_years</span><span class="p">)))</span> 
                                          <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;canal_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;segmento_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;grp_origem_reserva_cat&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_reserva&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;cd_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;referencia_semana&#39;</span><span class="p">,</span> <span class="s1">&#39;week_init&#39;</span><span class="p">,</span> <span class="s1">&#39;week_end&#39;</span><span class="p">)</span> 
                                          <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">))</span> 
                                          <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;ano&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                          <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                          <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dayofmonth</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                                          <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols</span><span class="p">)</span> 
                                          <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">))</span> 
                                          <span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                      <span class="p">)</span></div>

<div class="viewcode-block" id="MDD_Report._analysis_reservas_abertas"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report._analysis_reservas_abertas">[docs]</a>    <span class="k">def</span> <span class="nf">_analysis_reservas_abertas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Método interno da classe.</span>
<span class="sd">        Agrega a contagem de reservas abertas previstas para os próximos 60 dias a partir da data de execução, agrupado por segmento e tipo.</span>
<span class="sd">        Agrega também para o mesmo intervalo dos anos anteriores</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;segmento_crm&#39;</span><span class="p">,</span> <span class="s1">&#39;tp_reserva&#39;</span><span class="p">,</span> <span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="s1">&#39;mes&#39;</span><span class="p">]</span>
        
        <span class="c1"># Mesmo intervalo de datas nos anos pra trás</span>
        <span class="n">current_year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="n">past_years</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">considered_years</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">current_year</span><span class="p">]</span>

        <span class="c1"># Para o ano corrente</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span>
                 <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;today&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">()))</span> 
                 <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">))</span> 
                 <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dayofmonth</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                 <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> 
                 <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Aberta&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> 
                         <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;today&#39;</span><span class="p">))</span> <span class="o">&amp;</span> 
                         <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">datediff</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;today&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">))</span> 
                 <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">group_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">])</span>
             <span class="p">)</span>

        <span class="c1"># Agrupa</span>
        <span class="n">df_agg</span> <span class="o">=</span> <span class="p">(</span>
                     <span class="n">df</span>
                     <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols</span><span class="p">)</span> 
                     <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;qtd_reservas_abertas_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_year</span><span class="p">)))</span> 
                     <span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                 <span class="p">)</span>

        <span class="c1"># Reservas abertas no mesmo dia dos anos passados</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">past_years</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">current_year</span> <span class="o">-</span> <span class="n">i</span>

            <span class="n">df_1</span> <span class="o">=</span> <span class="p">(</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span>
                       <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;today&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">()))</span> \
                       <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;today_last_year&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">add_months</span><span class="p">(</span><span class="s1">&#39;today&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="o">*</span><span class="n">d</span><span class="p">)))</span> \
                       <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;dt_retirada_reserva&#39;</span><span class="p">))</span> \
                       <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dia&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dayofmonth</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> \
                       <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;mes&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">))</span> \
                       <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;data_criacao&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s1">&#39;dt_criacao_reserva&#39;</span><span class="p">))</span> \
                       <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Utilizada&#39;</span><span class="p">,</span> <span class="s1">&#39;Perdida&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> 
                               <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;data_criacao&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;today_last_year&#39;</span><span class="p">))</span> <span class="o">&amp;</span> 
                               <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;today_last_year&#39;</span><span class="p">))</span> <span class="o">&amp;</span> 
                               <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">datediff</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;today_last_year&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">))</span> 
                       <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">group_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">])</span>
                   <span class="p">)</span>

            <span class="c1"># Agrupa</span>
            <span class="n">df_1_agg</span> <span class="o">=</span> <span class="p">(</span>
                           <span class="n">df_1</span>
                           <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">group_cols</span><span class="p">)</span> 
                           <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;cd_reserva&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;qtd_reservas_abertas_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span> 
                           <span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                       <span class="p">)</span>

            <span class="n">df_agg</span> <span class="o">=</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_1_agg</span><span class="p">,</span> <span class="n">group_cols</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span>
        
        <span class="c1"># Final</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reservas_abertas</span> <span class="o">=</span> <span class="n">df_agg</span></div>

    <span class="c1"># ---------------------- All together -----------------------------</span>

<div class="viewcode-block" id="MDD_Report.execute_treatments"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report.execute_treatments">[docs]</a>    <span class="k">def</span> <span class="nf">execute_treatments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executa tratamentos das bases Reservas, Contratos e Balcão</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_filtro_agencias_corporacao</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_de_para_canal_crm</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_ota_nome_empresa</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_grupo_carro</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_canal_direto_indireto</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_date_related_columns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_dias_anteced_reserva</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_contrato_mae</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_status_reserva</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_reservas_anos_absurdos</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_valor_contrato_uplift_reserva</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treat_reservas_canceladas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_df_balcao</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drop_unrealistic_values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drop_rows_without_segmento</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_referencia_semana</span><span class="p">()</span></div>

<div class="viewcode-block" id="MDD_Report.execute_analysis"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report.execute_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">execute_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executa os métodos para gerar as tabelas agregadas</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_by_pickup_day_by_segment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_by_pickup_day_by_channel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_fleet_by_pickup_day_by_channel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_reservas_abertas</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="MDD_Report.base_dash"><a class="viewcode-back" href="../../../module/modulos.fluxos.html#modulos.fluxos.crm.MDD_Report.base_dash">[docs]</a>    <span class="k">def</span> <span class="nf">base_dash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executa os tratamentos, as análises e salva os resultados no Big Query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_rename_cols_df_reservas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rename_cols_df_contratos</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_treatments</span><span class="p">()</span>
        <span class="c1"># ---------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reservas</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_contratos</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_balcao</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="c1"># ---------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_analysis</span><span class="p">()</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_bkng_sgmt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Analise_Segmento&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_chnl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Analise_Canal&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservas_abertas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Reservas_Abertas&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_diaria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Antec_Media_Segmento_Dia&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_semanal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Antec_Media_Segmento_Semana&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_mensal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Antec_Media_Segmento_Mes&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antec_media_segmento_anual</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Antec_Media_Segmento_Ano&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_diaria</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Antec_Media_Canal_Dia&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_semanal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Antec_Media_Canal_Semana&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_mensal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Antec_Media_Canal_Mes&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antec_media_canal_anual</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Antec_MediaCanal_Ano&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_bkng_chnl_fleet_mix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Mix_Frota_Chnl&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span>
        <span class="n">save_BQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_referencia_semana</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_path_to_save_result</span><span class="o">+</span><span class="s1">&#39;MDD_Report_Data_Semana&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>